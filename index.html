<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>BSSC Task Tracker â€” Todd Cloud (Google Sheets)</title>

<style>
  /* ===== Dense / Scratchpad Mode ===== */
  :root{
    --bg:#000;
    --panel:#0b0b0b;
    --panel2:#070707;
    --line:#1e1e1e;
    --line2:#2a2a2a;
    --txt:#fff;
    --muted:#bdbdbd;
    --btn:#1a73e8;
  }

  body{
    margin:0;
    background:var(--bg);
    color:var(--txt);
    font-family:Verdana,Arial,sans-serif;
    font-size:12px;
  }

  header{
    display:flex;
    justify-content:space-between;
    align-items:center;
    padding:8px 10px;
    border-bottom:1px solid var(--line);
    background:var(--panel2);
    position:sticky;
    top:0;
    z-index:50;
  }
  h1{margin:0;font-size:14px;line-height:1;}
  .sub{opacity:.75;font-size:11px;margin-top:3px;}

  #addTaskBtn{
    background:var(--btn);
    color:#fff;
    border:none;
    border-radius:8px;
    padding:7px 10px;
    font-size:12px;
    font-weight:700;
    cursor:pointer;
  }
  #addTaskBtn:hover{filter:brightness(1.06);}

  .wrap{max-width:1200px;margin:0 auto;padding:8px 10px;}

  .note{
    border:1px solid var(--line2);
    background:var(--panel);
    padding:8px 10px;
    margin:0 0 8px;
    border-radius:10px;
    line-height:1.35;
    font-size:11px;
    opacity:.95;
  }

  /* ===== Savage Banner (keep, but dense) ===== */
  #savageZone{display:none;margin:0 0 8px;}
  .savage{
    border:1px solid #7a0000;
    background:#190000;
    border-radius:10px;
    padding:8px 10px;
  }
  .savage h3{margin:0 0 4px;color:#ffb3b3;font-size:12px;}
  .savage p{margin:4px 0;font-size:12px;line-height:1.25;}
  .savage .meta{opacity:.9;font-size:11px;}
  .savage .actions{margin-top:6px;display:flex;gap:6px;flex-wrap:wrap;}
  .savage button{
    background:#000;color:#fff;border:1px solid #444;border-radius:8px;
    padding:5px 8px;cursor:pointer;font-size:11px;
  }
  .savage button:hover{border-color:#888;}

  /* ===== Dense Tier Sections ===== */
  .tier{
    border:1px solid var(--line2);
    background:var(--panel);
    border-radius:10px;
    margin:0 0 8px;
    overflow:hidden;
  }

  .tierHead{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    padding:6px 10px;
    background:#0a0a0a;
    border-bottom:1px solid var(--line);
  }
  .tierTitle{
    font-size:12px;
    font-weight:800;
    letter-spacing:.2px;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }
  .tierHint{
    font-size:10px;
    opacity:.7;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
    text-align:right;
  }

  /* ===== Dense Row Grid ===== */
  .row{
    display:grid;
    grid-template-columns: 18px 1fr 86px 180px 64px;
    gap:10px;
    align-items:center;
    padding:4px 10px;
    border-bottom:1px solid #141414;
  }
  .row:last-child{border-bottom:none;}

  input[type="checkbox"]{width:14px;height:14px;cursor:pointer;margin:0;}
  .taskText{
    font-weight:600;
    font-size:12px;
    line-height:1.2;
    word-break:break-word;
  }
  .taskText.done{text-decoration:line-through;opacity:.45;}
  .taskText.waiting{opacity:.70;font-style:italic;}

  select, input[type="text"]{
    background:#0a0a0a;
    color:#fff;
    border:1px solid #333;
    border-radius:8px;
    padding:4px 6px;
    font-size:11px;
    height:26px;
  }

  .status-ready{color:#ff4d4d;font-weight:900;}
  .status-waiting{color:#ffd24d;font-weight:900;}
  .status-done{color:#5cff5c;font-weight:900;}

  .btns{display:flex;gap:6px;justify-content:flex-end;}
  .iconBtn{
    background:#000;border:1px solid #444;color:#fff;border-radius:8px;
    padding:4px 7px;cursor:pointer;font-size:11px;height:26px;
  }
  .iconBtn:hover{border-color:#888;}
  .danger:hover{border-color:#ff6b6b;}

  /* ===== Hall of Shame (dense) ===== */
  .hall{
    border:1px solid var(--line2);
    border-radius:10px;
    padding:8px 10px;
    background:var(--panel);
    margin-top:8px;
  }
  .hall h3{margin:0 0 8px;font-size:12px;}
  .log{
    font-size:11px;
    opacity:.92;
    border-bottom:1px solid #141414;
    padding:4px 0;
    line-height:1.25;
  }
  .log:last-child{border-bottom:none;}
  .pill{
    display:inline-block;
    padding:1px 6px;
    border:1px solid #333;
    border-radius:999px;
    font-size:10px;
    margin-right:6px;
    opacity:.95;
  }

  /* ===== Modal ===== */
  #modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.78);z-index:999;}
  #modalBox{
    width:380px;max-width:92vw;margin:90px auto;background:#0b0b0b;border:1px solid #333;
    border-radius:12px;padding:12px;
  }
  #modalBox h3{margin:0 0 10px;font-size:13px;}
  #modalBox label{display:block;font-size:11px;opacity:.85;margin:8px 0 5px;}
  #modalBox .error{display:none;color:#ff6b6b;font-size:11px;margin:0 0 6px;}
  #modalActions{display:flex;gap:8px;justify-content:flex-end;margin-top:10px;}
  #modalActions button{
    background:#000;color:#fff;border:1px solid #444;border-radius:8px;
    padding:7px 10px;cursor:pointer;font-size:11px;
  }
  #modalActions button:hover{border-color:#888;}

  /* Responsive: keep dense but not broken */
  @media(max-width:900px){
    .row{grid-template-columns: 18px 1fr 86px 1fr 64px;}
  }
  @media(max-width:650px){
    .row{grid-template-columns: 18px 1fr;}
    .row > *:nth-child(3),
    .row > *:nth-child(4),
    .row > *:nth-child(5){grid-column:2;}
    .btns{justify-content:flex-start;}
    .tierHint{display:none;}
  }
</style>
</head>

<body>
<header>
  <div>
    <h1>BSSC Task Tracker</h1>
    <div class="sub">Dense scratchpad â€¢ Todd Cloud (Google Sheets) â€¢ Ready / Waiting / Done</div>
  </div>
  <button id="addTaskBtn">Add Task</button>
</header>

<div class="wrap">

  <div class="note">
    <b>Statuses:</b>
    <span class="status-ready">READY</span> = actionable now â€¢
    <span class="status-waiting">WAITING</span> = blocked â€¢
    <span class="status-done">DONE</span> = finished (still visible, can undo)
    <br><br>
    <b>Nag cadence:</b> Tier 1 daily â€¢ Tier 2 daily â€¢ Tier 3 every other day â€¢ Tier 4 every 2 days â€¢ Tier 5 weekly
  </div>

  <div id="savageZone"></div>

  <div id="board"></div>

  <div class="hall">
    <h3>Hall of Shame (DONE Tasks)</h3>
    <div id="logs"></div>
  </div>
</div>

<!-- Add/Edit Modal -->
<div id="modal">
  <div id="modalBox">
    <h3 id="modalTitle">Add Task</h3>
    <div id="modalError" class="error">Type something. Telepathy isnâ€™t enabled.</div>

    <label for="taskInput">Task</label>
    <input id="taskInput" type="text" placeholder="Enter task hereâ€¦" />

    <label for="tierSelect">Tier</label>
    <select id="tierSelect"></select>

    <label for="statusSelect">Status</label>
    <select id="statusSelect">
      <option value="ready">READY</option>
      <option value="waiting">WAITING</option>
      <option value="done">DONE</option>
    </select>

    <label for="notesInput">Notes (optional)</label>
    <input id="notesInput" type="text" placeholder="Optional notesâ€¦" />

    <div id="modalActions">
      <button id="cancelBtn" type="button">Cancel</button>
      <button id="saveBtn" type="button">Save</button>
    </div>
  </div>
</div>

<script>
/* =========================
   CLOUD BACKEND (LOCKED)
   ========================= */
const API_URL = "https://script.google.com/macros/s/AKfycbyCVOwhCtWJX2X7bQE9dVNKgtVt-TBt8HTioqFf9Xk1EY-XM8joKX9GS5a0gAzvwouZgw/exec";

/* =========================
   CONSTANTS / TIERS
   ========================= */
const DAY_MS = 24*60*60*1000;

const TIERS = [
  { id:"tier1", title:"ðŸ”´ Tier 1 â€” Critical / Must Do First", cadenceDays:1 },
  { id:"tier2", title:"ðŸŸ  Tier 2 â€” High Impact Operations", cadenceDays:1 },
  { id:"tier3", title:"ðŸŸ¡ Tier 3 â€” Revenue & Program Growth", cadenceDays:2 },
  { id:"tier4", title:"ðŸ”µ Tier 4 â€” Brand / Identity", cadenceDays:2 },
  { id:"tier5", title:"ðŸŸ£ Tier 5 â€” Content / Nice-to-Have", cadenceDays:7 },
  { id:"parked",title:"âšª Parked / Deprecated", cadenceDays:null }
];

/* =========================
   SAVAGE MESSAGE ENGINE
   ========================= */
const ROAST = {
  tier1: [
    "Tier 1 is still open. Thatâ€™s not a vibe. Thatâ€™s a problem.",
    "Tier 1 overdue. Congratulations, youâ€™ve invented chaos again.",
    "This is critical. Pretending itâ€™s fine does not count as progress.",
    "Tier 1 ignored long enough to qualify as negligence."
  ],
  tier2: [
    "Tier 2 is aging like milk. You gonna do anything or nah?",
    "High-impact stuff doesnâ€™t complete itself. Tragically.",
    "Tier 2 is overdue. Thatâ€™s how good systems become â€˜later problemsâ€™."
  ],
  tier3: [
    "Tier 3 called. Growth is not happening by vibes.",
    "We should be arrested for this level of tomfoolery.",
    "This is not blocked. This is being avoided professionally."
  ],
  tier4: [
    "Tier 4 sitting there like a neglected haircut appointment.",
    "Brand work ignored = redo everything later. Pick your pain.",
    "Tier 4 overdue. This is how you end up with â€˜randomâ€™ branding."
  ],
  tier5: [
    "Tier 5 has been ignored so long itâ€™s basically a historical site.",
    "Tier 5 overdue. This is peak nonsense. Elite procrastination.",
    "Tier 5 is still waiting. Patient little thing, isnâ€™t it?"
  ]
};

function todayKey(){ return new Date().toDateString(); }
function randPick(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

/* =========================
   STATE
   ========================= */
let tasks = []; // normalized task objects
let naggedDate = {};   // tierId -> todayKey
let msgHist = {};      // tierId -> [messages used recently]

/* =========================
   API HELPERS (robust)
   ========================= */
async function apiGet(){
  const url = API_URL + "?action=get&ts=" + Date.now();
  const r = await fetch(url, { method:"GET" });
  const txt = await r.text();
  let parsed;
  try { parsed = JSON.parse(txt); }
  catch(e){
    throw new Error("API did not return JSON. First 200 chars: " + txt.slice(0,200));
  }

  // Supports:
  // 1) {success:true, tasks:[...]}
  // 2) array-of-arrays (legacy)
  return parsed;
}

async function apiPost(action, payload){
  const r = await fetch(API_URL, {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({ action, ...payload })
  });
  const txt = await r.text();
  let parsed;
  try { parsed = JSON.parse(txt); }
  catch(e){
    throw new Error("API POST did not return JSON. First 200 chars: " + txt.slice(0,200));
  }
  return parsed;
}

/* =========================
   NORMALIZE TASK SHAPES
   ========================= */
function normalizeId(v){
  const s = String(v ?? "").trim();
  return s;
}
function toLower(v){ return String(v ?? "").trim().toLowerCase(); }
function numOrNow(v){
  const n = Number(v);
  return (isFinite(n) && n>0) ? n : Date.now();
}
function numOrZero(v){
  const n = Number(v);
  return (isFinite(n) && n>0) ? n : 0;
}

function normalizeTaskFromObj(o){
  // Accepts either:
  // {ID,Task,Tier,Status,Created,Updated,SnoozeUntil,Completed,Notes}
  // or {id,task,tier,status,createdAt,...} etc.
  const id = normalizeId(o.ID ?? o.id);
  const text = String(o.Task ?? o.task ?? o.text ?? "").trim();
  const tier = String(o.Tier ?? o.tier ?? "tier1").trim() || "tier1";
  const status = toLower(o.Status ?? o.status ?? "ready");
  const st = ["ready","waiting","done"].includes(status) ? status : "ready";

  if(!id || !text) return null;

  return {
    id,
    tier,
    text,
    status: st,
    createdAt: numOrNow(o.Created ?? o.createdAt),
    updatedAt: numOrNow(o.Updated ?? o.updatedAt),
    snoozeUntil: numOrZero(o.SnoozeUntil ?? o.snoozeUntil),
    completedAt: numOrZero(o.Completed ?? o.completedAt),
    notes: String(o.Notes ?? o.notes ?? "")
  };
}

function rowsToTasks(rows){
  // legacy: [[headers...],[row...],...]
  if(!Array.isArray(rows) || rows.length === 0) return [];
  const header = rows[0].map(h => String(h||"").trim());
  const col = {};
  header.forEach((h,i)=> col[h] = i);

  const get = (row, name) => {
    const idx = col[name];
    return (idx === undefined) ? "" : row[idx];
  };

  const out = [];
  for(let i=1;i<rows.length;i++){
    const row = rows[i];
    if(!row || row.length===0) continue;

    const obj = {
      ID: get(row,"ID"),
      Task: get(row,"Task"),
      Tier: get(row,"Tier"),
      Status: get(row,"Status"),
      Created: get(row,"Created"),
      Updated: get(row,"Updated"),
      SnoozeUntil: get(row,"SnoozeUntil"),
      Completed: get(row,"Completed"),
      Notes: get(row,"Notes")
    };
    const t = normalizeTaskFromObj(obj);
    if(t) out.push(t);
  }
  return out;
}

/* =========================
   UI HELPERS
   ========================= */
function statusClass(status){
  if(status==="ready") return "status-ready";
  if(status==="waiting") return "status-waiting";
  return "status-done";
}
function taskTextClass(status){
  if(status==="done") return "taskText done";
  if(status==="waiting") return "taskText waiting";
  return "taskText";
}

function pickNonRepeatingMessage(tierId){
  const pool = ROAST[tierId] || ["Do the thing."];
  const hist = msgHist[tierId] || [];
  const candidates = pool.filter(m => !hist.includes(m));
  const chosen = candidates.length ? randPick(candidates) : randPick(pool);
  msgHist[tierId] = [chosen].concat(hist).slice(0,6);
  return chosen;
}

function daysSince(ms){
  return Math.floor((Date.now()-ms)/DAY_MS);
}

/* =========================
   CLOUD LOAD / REFRESH
   ========================= */
async function reloadCloud(){
  const raw = await apiGet();

  // Case A: {success:true, tasks:[...]}
  if(raw && typeof raw === "object" && !Array.isArray(raw) && Array.isArray(raw.tasks)){
    const normalized = raw.tasks
      .map(normalizeTaskFromObj)
      .filter(Boolean);

    tasks = normalized;
    return;
  }

  // Case B: array-of-arrays legacy
  if(Array.isArray(raw)){
    tasks = rowsToTasks(raw);
    return;
  }

  // Case C: error object
  if(raw && typeof raw === "object" && raw.success === false){
    throw new Error(raw.message || "API returned success:false");
  }

  throw new Error("Unexpected API response shape.");
}

/* =========================
   SAVE/UPDATE/DELETE (robust)
   ========================= */
async function postUpsert(task){
  // Try modern backend first
  let res = await apiPost("upsert", { task });
  if(res && res.success === true) return res;

  // Fallback: older backend might only support "save"
  if(res && res.success === false && String(res.message||"").toLowerCase().includes("invalid post action")){
    // Backend save expects: {action:"save", task, tier, status, notes, id?}
    // We'll pass best-effort fields.
    res = await apiPost("save", {
      id: task.id,
      task: task.text,
      tier: task.tier,
      status: task.status,
      notes: task.notes || "",
      // optional timestamps for smarter backends
      createdAt: task.createdAt,
      updatedAt: task.updatedAt,
      snoozeUntil: task.snoozeUntil,
      completedAt: task.completedAt
    });
    if(res && res.success === true) return res;
  }

  // If still failing, throw
  throw new Error(res?.message || "Save failed.");
}

async function postDelete(id){
  const res = await apiPost("delete", { id });
  if(res && res.success === true) return res;
  throw new Error(res?.message || "Delete failed.");
}

/* =========================
   ACCOUNTABILITY ALERT
   ========================= */
function buildSavageBanner(){
  const zone = document.getElementById("savageZone");
  zone.innerHTML="";
  zone.style.display="none";

  const now = Date.now();
  const today = todayKey();

  const overdue = [];
  TIERS.forEach(t=>{
    if(t.cadenceDays == null) return;

    const candidates = tasks.filter(x =>
      x.tier===t.id &&
      x.status==="ready" &&
      (!x.snoozeUntil || x.snoozeUntil <= now)
    );
    if(!candidates.length) return;

    candidates.sort((a,b)=>(a.updatedAt||0)-(b.updatedAt||0));
    const oldest = candidates[0];
    const since = daysSince(oldest.updatedAt || now);

    if(since >= t.cadenceDays){
      overdue.push({ tier:t, since });
    }
  });

  if(!overdue.length) return;

  overdue.sort((a,b)=> b.since - a.since);
  const pick = overdue[0];
  const tierId = pick.tier.id;

  let msg;
  if(naggedDate[tierId] !== today){
    msg = pickNonRepeatingMessage(tierId);
    naggedDate[tierId] = today;
  } else {
    const hist = msgHist[tierId] || [];
    msg = hist[0] || pickNonRepeatingMessage(tierId);
  }

  zone.style.display="block";
  const card = document.createElement("div");
  card.className="savage";
  card.innerHTML = `
    <h3>Accountability Alert</h3>
    <div class="meta"><b>${pick.tier.title}</b> â€¢ You havenâ€™t moved READY work in <b>${pick.since}</b> day(s).</div>
    <p>${msg}</p>
    <div class="actions">
      <button type="button" data-snooze="1">Snooze 1d</button>
      <button type="button" data-snooze="3">Snooze 3d</button>
      <button type="button" data-snooze="7">Snooze 7d</button>
      <button type="button" data-jump="1">Jump</button>
    </div>
  `;

  card.querySelectorAll("button[data-snooze]").forEach(btn=>{
    btn.onclick=async ()=>{
      const d = Number(btn.getAttribute("data-snooze"));
      await snoozeTier(tierId, d);
    };
  });
  card.querySelector("button[data-jump]").onclick=()=>{
    const el = document.getElementById(tierId);
    if(el && el.scrollIntoView) el.scrollIntoView({behavior:"smooth"});
  };

  zone.appendChild(card);
}

async function snoozeTier(tierId, days){
  const until = Date.now() + days*DAY_MS;
  const targets = tasks.filter(t => t.tier===tierId && t.status==="ready");
  for(const t of targets){
    t.snoozeUntil = until;
    t.updatedAt = Date.now();
    await postUpsert(t);
  }
  await refresh();
}

/* =========================
   RENDER BOARD (DENSE)
   ========================= */
function render(){
  buildSavageBanner();

  const board = document.getElementById("board");
  board.innerHTML="";

  const statusOrder = { ready:0, waiting:1, done:2 };

  TIERS.forEach(tier=>{
    const card = document.createElement("div");
    card.className="tier";
    card.id = tier.id;

    const hint = tier.cadenceDays==null
      ? "Parked never nags."
      : `Nag: ${tier.cadenceDays}d if READY exists.`;

    const head = document.createElement("div");
    head.className="tierHead";
    head.innerHTML = `
      <div class="tierTitle">${tier.title}</div>
      <div class="tierHint">${hint}</div>
    `;
    card.appendChild(head);

    const tierTasks = tasks
      .filter(x => x.tier === tier.id)
      .sort((a,b)=> statusOrder[a.status]-statusOrder[b.status]);

    tierTasks.forEach(task=>{
      const row = document.createElement("div");
      row.className="row";

      // Checkbox: toggles DONE <-> READY (keeps your â€œfastâ€ workflow)
      const cb = document.createElement("input");
      cb.type="checkbox";
      cb.checked = (task.status==="done");
      cb.onchange = async ()=>{
        task.status = cb.checked ? "done" : "ready";
        task.updatedAt = Date.now();
        task.completedAt = (task.status==="done") ? Date.now() : 0;
        await postUpsert(task);
        await refresh();
      };

      // Text
      const text = document.createElement("div");
      text.className = taskTextClass(task.status);
      text.textContent = task.text;

      // Status dropdown
      const status = document.createElement("select");
      ["ready","waiting","done"].forEach(s=>{
        const opt=document.createElement("option");
        opt.value=s;
        opt.textContent=s.toUpperCase();
        if(task.status===s) opt.selected=true;
        status.appendChild(opt);
      });
      status.className = statusClass(task.status);
      status.onchange = async ()=>{
        task.status = status.value;
        task.updatedAt = Date.now();
        task.completedAt = (task.status==="done") ? Date.now() : 0;
        await postUpsert(task);
        await refresh();
      };

      // Move tier dropdown
      const move = document.createElement("select");
      TIERS.forEach(tt=>{
        const opt=document.createElement("option");
        opt.value=tt.id;
        opt.textContent=tt.title;
        if(task.tier===tt.id) opt.selected=true;
        move.appendChild(opt);
      });
      move.onchange = async ()=>{
        task.tier = move.value;
        task.updatedAt = Date.now();
        await postUpsert(task);
        await refresh();
      };

      // Edit/Delete buttons
      const btnWrap = document.createElement("div");
      btnWrap.className="btns";

      const editBtn = document.createElement("button");
      editBtn.className="iconBtn";
      editBtn.type="button";
      editBtn.textContent="âœï¸";
      editBtn.title="Edit";
      editBtn.onclick=()=>openModal("edit", task);

      const delBtn = document.createElement("button");
      delBtn.className="iconBtn danger";
      delBtn.type="button";
      delBtn.textContent="ðŸ—‘ï¸";
      delBtn.title="Delete";
      delBtn.onclick=async ()=>{
        const ok = confirm("Delete this task?\n\n" + task.text);
        if(!ok) return;
        await postDelete(task.id);
        await refresh();
      };

      btnWrap.appendChild(editBtn);
      btnWrap.appendChild(delBtn);

      row.appendChild(cb);
      row.appendChild(text);
      row.appendChild(status);
      row.appendChild(move);
      row.appendChild(btnWrap);

      card.appendChild(row);
    });

    board.appendChild(card);
  });

  renderHallOfShame();
}

/* =========================
   HALL OF SHAME
   ========================= */
function renderHallOfShame(){
  const el = document.getElementById("logs");
  const done = tasks
    .filter(t=>t.status==="done")
    .sort((a,b)=>(b.completedAt||0)-(a.completedAt||0));

  if(!done.length){
    el.innerHTML = `<div class="log">No DONE tasks yet.</div>`;
    return;
  }

  el.innerHTML = done.map(t=>{
    const when = t.completedAt ? new Date(t.completedAt).toLocaleString() : "â€”";
    return `<div class="log">
      <span class="pill">${when}</span>
      <span class="pill">${t.tier}</span>
      ${escapeHtml(t.text)}
    </div>`;
  }).join("");
}

function escapeHtml(s){
  return String(s ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

/* =========================
   MODAL
   ========================= */
const modal = document.getElementById("modal");
const modalTitle = document.getElementById("modalTitle");
const modalError = document.getElementById("modalError");
const taskInput = document.getElementById("taskInput");
const notesInput = document.getElementById("notesInput");
const tierSelect = document.getElementById("tierSelect");
const statusSelect = document.getElementById("statusSelect");
const cancelBtn = document.getElementById("cancelBtn");
const saveBtn = document.getElementById("saveBtn");
const addTaskBtn = document.getElementById("addTaskBtn");

let modalMode = "add";
let editTaskId = null;

function fillTierOptions(){
  tierSelect.innerHTML="";
  TIERS.forEach(t=>{
    const opt=document.createElement("option");
    opt.value=t.id;
    opt.textContent=t.title;
    tierSelect.appendChild(opt);
  });
}
fillTierOptions();

function openModal(mode, task){
  modalMode = mode;
  modalError.style.display="none";

  if(mode==="add"){
    modalTitle.textContent="Add Task";
    editTaskId = null;
    taskInput.value="";
    notesInput.value="";
    tierSelect.value="tier1";
    statusSelect.value="ready";
  } else {
    modalTitle.textContent="Edit Task";
    editTaskId = task.id;
    taskInput.value = task.text;
    notesInput.value = task.notes || "";
    tierSelect.value = task.tier;
    statusSelect.value = task.status;
  }

  modal.style.display="block";
  setTimeout(()=>taskInput.focus(), 30);
}

function closeModal(){ modal.style.display="none"; }

async function saveModal(){
  const text = (taskInput.value||"").trim();
  if(!text){
    modalError.textContent = "Type something. Telepathy isnâ€™t enabled.";
    modalError.style.display="block";
    taskInput.focus();
    return;
  }

  const now = Date.now();

  if(modalMode==="add"){
    const newTask = {
      id: "t_"+now+"_"+Math.floor(Math.random()*100000),
      tier: tierSelect.value,
      text,
      status: statusSelect.value,
      createdAt: now,
      updatedAt: now,
      snoozeUntil: 0,
      completedAt: (statusSelect.value==="done") ? now : 0,
      notes: (notesInput.value||"").trim()
    };
    await postUpsert(newTask);
  } else {
    const t = tasks.find(x=>x.id===editTaskId);
    if(t){
      t.text = text;
      t.tier = tierSelect.value;
      t.status = statusSelect.value;
      t.notes = (notesInput.value||"").trim();
      t.updatedAt = now;
      t.completedAt = (t.status==="done") ? now : 0;
      await postUpsert(t);
    }
  }

  closeModal();
  await refresh();

  const dest = document.getElementById(tierSelect.value);
  if(dest && dest.scrollIntoView) dest.scrollIntoView({behavior:"smooth"});
}

addTaskBtn.onclick = ()=>openModal("add");
cancelBtn.onclick = closeModal;
saveBtn.onclick = saveModal;

taskInput.addEventListener("keydown", (e)=>{
  if(e.key==="Enter") saveModal();
  if(e.key==="Escape") closeModal();
});
modal.addEventListener("click", (e)=>{
  if(e.target === modal) closeModal();
});

/* =========================
   BOOT / REFRESH
   ========================= */
async function refresh(){
  try{
    await reloadCloud();
    render();
  } catch(err){
    alert("Cloud load failed.\n\n" + err.message);
    console.error("Cloud load failed:", err);
  }
}

refresh();
setInterval(()=>{ buildSavageBanner(); }, 60000);
</script>
</body>
</html>


